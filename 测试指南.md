# åˆ†å¸ƒå¼æœåŠ¡ç›‘æ§ä¸éƒ¨ç½²ç³»ç»Ÿ - æµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡
éƒ¨ç½²é…ç½®çš„é¡¹ç›®åˆ°é…ç½®çš„AgentèŠ‚ç‚¹ï¼ˆä»application.ymlè‡ªåŠ¨è¯»å–ï¼‰

## ğŸ“‹ å‰ç½®æ¡ä»¶
1. RedisæœåŠ¡å·²å¯åŠ¨
2. MasterèŠ‚ç‚¹å·²å¯åŠ¨ (http://localhost:8080)
3. AgentèŠ‚ç‚¹å·²å¯åŠ¨ (http://localhost:8082)
4. ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®

## ğŸ”„ æµ‹è¯•æµç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šä»£ç ä¸‹è½½å’Œæ„å»º (Step 1)

#### æ–¹å¼1ï¼šä½¿ç”¨é…ç½®çš„Gitä»“åº“ï¼ˆæ¨èï¼Œæ— å‚æ•°ç‰ˆæœ¬ï¼‰
```bash
# æµ‹è¯•å‘½ä»¤ï¼ˆæ— å‚æ•°ï¼Œè‡ªåŠ¨ä»é…ç½®è¯»å–ï¼‰
curl -X POST "http://localhost:8080/api/deploy/step1-download-and-build"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤1å®Œæˆï¼šä»£ç ä¸‹è½½å’Œæ„å»ºæˆåŠŸ (é¡¹ç›®: service-abc)",
  "data": "/tmp/deploy/distribute/service-abc/abc-1.0.0.jar"
}
```

#### æ–¹å¼2ï¼šæ‰‹åŠ¨æŒ‡å®šGitä»“åº“
```bash
# æµ‹è¯•å‘½ä»¤
curl -X POST "http://localhost:8080/api/deploy/step1-manual-download-and-build" \
  -d "gitUrl=https://git.code.tencent.com/gtest/abc.git" \
  -d "branch=dev" \
  -d "projectName=service-abc" \
  -d "buildCommand=mvn clean package -DskipTests"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤1å®Œæˆï¼šæ‰‹åŠ¨ä¸‹è½½å’Œæ„å»ºæˆåŠŸ",
  "data": "/tmp/deploy/distribute/service-abc/abc-1.0.0.jar"
}
```

#### æ–¹å¼3ï¼šç›´æ¥ä¸Šä¼ JARåŒ…
```bash
# æµ‹è¯•å‘½ä»¤ï¼ˆå¦‚æœæœ‰ç°æˆçš„JARåŒ…ï¼‰
curl -X POST "http://localhost:8080/api/deploy/step1-upload-jar" \
  -F "file=@abc-1.0.0.jar"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤1å®Œæˆï¼šJARåŒ…ä¸Šä¼ æˆåŠŸ",
  "data": "/tmp/services/abc-1.0.0.jar"
}
```

### ç¬¬äºŒé˜¶æ®µï¼šæœåŠ¡éƒ¨ç½² (Step 2)

#### æ–¹å¼1ï¼šéƒ¨ç½²å•ä¸ªæœåŠ¡ï¼ˆæ— å‚æ•°ç‰ˆæœ¬ï¼‰
```bash
# æµ‹è¯•å‘½ä»¤ï¼ˆæ— å‚æ•°ï¼Œè‡ªåŠ¨ä»é…ç½®è¯»å–ï¼‰
curl -X POST "http://localhost:8080/api/deploy/step2-deploy-service" \
  -H "Content-Type: application/json"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤2å®Œæˆï¼šæœåŠ¡éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»º (æœåŠ¡: service-abc)",
  "data": "task-12345"
}
```

#### æ–¹å¼2ï¼šä¸€é”®éƒ¨ç½²æ‰€æœ‰æœåŠ¡ï¼ˆæ— å‚æ•°ç‰ˆæœ¬ï¼‰
```bash
# æµ‹è¯•å‘½ä»¤ï¼ˆæ— å‚æ•°ï¼Œè‡ªåŠ¨ä»é…ç½®è¯»å–ï¼‰
curl -X POST "http://localhost:8080/api/deploy/step2-deploy-all" \
  -H "Content-Type: application/json"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤2å®Œæˆï¼šæ‰¹é‡éƒ¨ç½²ä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "taskIds": ["task-12345", "task-12346"],
    "totalTasks": 2
  }
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šçŠ¶æ€ç›‘æ§ (Step 3)

#### æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
```bash
# æµ‹è¯•å‘½ä»¤
curl -X GET "http://localhost:8080/api/deploy/step3-task-status/task-12345"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤3å®Œæˆï¼šä»»åŠ¡çŠ¶æ€æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "taskId": "task-12345",
    "status": "RUNNING",
    "progress": 50,
    "message": "æ­£åœ¨éƒ¨ç½²æœåŠ¡åˆ°èŠ‚ç‚¹ node001"
  }
}
```

#### æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æœåŠ¡
```bash
# æµ‹è¯•å‘½ä»¤
curl -X GET "http://localhost:8080/api/deploy/step3-available-services"

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤3å®Œæˆï¼šæœåŠ¡åˆ—è¡¨æŸ¥è¯¢æˆåŠŸ",
  "data": [
    {
      "name": "service-abc",
      "version": "1.0.0",
      "status": "RUNNING",
      "nodes": ["node001"]
    }
  ]
}
```

### ç¬¬å››é˜¶æ®µï¼šæœåŠ¡ç®¡ç† (Step 4)

#### å›æ»šæœåŠ¡
```bash
# æµ‹è¯•å‘½ä»¤
curl -X POST "http://localhost:8080/api/deploy/step4-rollback-selected" \
  -H "Content-Type: application/json" \
  -d '{
    "serviceNames": ["service-abc"],
    "targetNodes": ["node001"]
  }'

# é¢„æœŸç»“æœ
{
  "success": true,
  "message": "æ­¥éª¤4å®Œæˆï¼šé€‰å®šæœåŠ¡å›æ»šä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "rollbackTasks": ["rollback-task-12345"],
    "totalTasks": 1
  }
}
```

## ğŸš€ å¿«é€Ÿæµ‹è¯•è„šæœ¬

### ä¸€é”®æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash

echo "å¼€å§‹æµ‹è¯•åˆ†å¸ƒå¼æœåŠ¡ç›‘æ§ä¸éƒ¨ç½²ç³»ç»Ÿ..."

# æ­¥éª¤1ï¼šä¸‹è½½å’Œæ„å»ºï¼ˆæ— å‚æ•°ï¼‰
echo "æ­¥éª¤1ï¼šä¸‹è½½å’Œæ„å»ºä»£ç ..."
RESPONSE1=$(curl -s -X POST "http://localhost:8080/api/deploy/step1-download-and-build")
echo "æ­¥éª¤1ç»“æœ: $RESPONSE1"

# æ­¥éª¤2ï¼šéƒ¨ç½²æœåŠ¡ï¼ˆæ— å‚æ•°ï¼‰
echo "æ­¥éª¤2ï¼šéƒ¨ç½²æœåŠ¡..."
RESPONSE2=$(curl -s -X POST "http://localhost:8080/api/deploy/step2-deploy-service" \
  -H "Content-Type: application/json")
echo "æ­¥éª¤2ç»“æœ: $RESPONSE2"

# æ­¥éª¤3ï¼šæŸ¥çœ‹çŠ¶æ€
echo "æ­¥éª¤3ï¼šæŸ¥çœ‹æœåŠ¡çŠ¶æ€..."
RESPONSE3=$(curl -s -X GET "http://localhost:8080/api/deploy/step3-available-services")
echo "æ­¥éª¤3ç»“æœ: $RESPONSE3"

echo "æµ‹è¯•å®Œæˆï¼"
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **ç«¯å£å†²çª**ï¼šç¡®ä¿Master(8080)ã€Agent(8082)ã€æ–‡ä»¶æœåŠ¡å™¨(8081)ç«¯å£ä¸å†²çª
2. **ç›®å½•æƒé™**ï¼šç¡®ä¿ `/tmp` ç›®å½•æœ‰è¯»å†™æƒé™
3. **Redisè¿æ¥**ï¼šç¡®ä¿RedisæœåŠ¡æ­£å¸¸è¿è¡Œ
4. **Gitè®¤è¯**ï¼šç¡®ä¿Gitä»“åº“URLå’Œè®¤è¯ä¿¡æ¯æ­£ç¡®

### æ—¥å¿—æŸ¥çœ‹
```bash
# MasterèŠ‚ç‚¹æ—¥å¿—
tail -f logs/master.log

# AgentèŠ‚ç‚¹æ—¥å¿—
tail -f logs/agent.log
```

## ğŸ“Š éªŒè¯æ¸…å•

- [ ] MasterèŠ‚ç‚¹å¯åŠ¨æˆåŠŸ
- [ ] AgentèŠ‚ç‚¹å¯åŠ¨æˆåŠŸ
- [ ] Redisè¿æ¥æ­£å¸¸
- [ ] ä»£ç ä¸‹è½½æˆåŠŸ
- [ ] JARåŒ…æ„å»ºæˆåŠŸ
- [ ] æœåŠ¡éƒ¨ç½²æˆåŠŸ
- [ ] æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] ç›‘æ§çŠ¶æ€æ­£å¸¸

## ğŸ‰ æˆåŠŸæ ‡å¿—

å½“çœ‹åˆ°ä»¥ä¸‹ä¿¡æ¯æ—¶ï¼Œè¯´æ˜æµ‹è¯•æˆåŠŸï¼š
1. æ‰€æœ‰APIè°ƒç”¨è¿”å› `"success": true`
2. JARåŒ…æˆåŠŸç”Ÿæˆåœ¨é…ç½®çš„è·¯å¾„ï¼ˆä»services.jar-pathè¯»å–ï¼‰
3. æœåŠ¡åœ¨é…ç½®çš„AgentèŠ‚ç‚¹ä¸ŠæˆåŠŸå¯åŠ¨ï¼ˆä»services.target-nodesè¯»å–ï¼‰
4. ç›‘æ§æ˜¾ç¤ºæœåŠ¡çŠ¶æ€ä¸º `RUNNING`
