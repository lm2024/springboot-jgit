# 分布式服务监控与部署系统 - 测试指南

## 🎯 测试目标
部署配置的项目到配置的Agent节点（从application.yml自动读取）

## 📋 前置条件
1. Redis服务已启动
2. Master节点已启动 (http://localhost:8080)
3. Agent节点已启动 (http://localhost:8082)
4. 确保目录权限正确

## 🔄 测试流程

### 第一阶段：代码下载和构建 (Step 1)

#### 方式1：使用配置的Git仓库（推荐，无参数版本）
```bash
# 测试命令（无参数，自动从配置读取）
curl -X POST "http://localhost:8080/api/deploy/step1-download-and-build"

# 预期结果
{
  "success": true,
  "message": "步骤1完成：代码下载和构建成功 (项目: service-abc)",
  "data": "/tmp/deploy/distribute/service-abc/abc-1.0.0.jar"
}
```

#### 方式2：手动指定Git仓库
```bash
# 测试命令
curl -X POST "http://localhost:8080/api/deploy/step1-manual-download-and-build" \
  -d "gitUrl=https://git.code.tencent.com/gtest/abc.git" \
  -d "branch=dev" \
  -d "projectName=service-abc" \
  -d "buildCommand=mvn clean package -DskipTests"

# 预期结果
{
  "success": true,
  "message": "步骤1完成：手动下载和构建成功",
  "data": "/tmp/deploy/distribute/service-abc/abc-1.0.0.jar"
}
```

#### 方式3：直接上传JAR包
```bash
# 测试命令（如果有现成的JAR包）
curl -X POST "http://localhost:8080/api/deploy/step1-upload-jar" \
  -F "file=@abc-1.0.0.jar"

# 预期结果
{
  "success": true,
  "message": "步骤1完成：JAR包上传成功",
  "data": "/tmp/services/abc-1.0.0.jar"
}
```

### 第二阶段：服务部署 (Step 2)

#### 方式1：部署单个服务（无参数版本）
```bash
# 测试命令（无参数，自动从配置读取）
curl -X POST "http://localhost:8080/api/deploy/step2-deploy-service" \
  -H "Content-Type: application/json"

# 预期结果
{
  "success": true,
  "message": "步骤2完成：服务部署任务已创建 (服务: service-abc)",
  "data": "task-12345"
}
```

#### 方式2：一键部署所有服务（无参数版本）
```bash
# 测试命令（无参数，自动从配置读取）
curl -X POST "http://localhost:8080/api/deploy/step2-deploy-all" \
  -H "Content-Type: application/json"

# 预期结果
{
  "success": true,
  "message": "步骤2完成：批量部署任务已创建",
  "data": {
    "taskIds": ["task-12345", "task-12346"],
    "totalTasks": 2
  }
}
```

### 第三阶段：状态监控 (Step 3)

#### 查看任务状态
```bash
# 测试命令
curl -X GET "http://localhost:8080/api/deploy/step3-task-status/task-12345"

# 预期结果
{
  "success": true,
  "message": "步骤3完成：任务状态查询成功",
  "data": {
    "taskId": "task-12345",
    "status": "RUNNING",
    "progress": 50,
    "message": "正在部署服务到节点 node001"
  }
}
```

#### 查看所有可用服务
```bash
# 测试命令
curl -X GET "http://localhost:8080/api/deploy/step3-available-services"

# 预期结果
{
  "success": true,
  "message": "步骤3完成：服务列表查询成功",
  "data": [
    {
      "name": "service-abc",
      "version": "1.0.0",
      "status": "RUNNING",
      "nodes": ["node001"]
    }
  ]
}
```

### 第四阶段：服务管理 (Step 4)

#### 回滚服务
```bash
# 测试命令
curl -X POST "http://localhost:8080/api/deploy/step4-rollback-selected" \
  -H "Content-Type: application/json" \
  -d '{
    "serviceNames": ["service-abc"],
    "targetNodes": ["node001"]
  }'

# 预期结果
{
  "success": true,
  "message": "步骤4完成：选定服务回滚任务已创建",
  "data": {
    "rollbackTasks": ["rollback-task-12345"],
    "totalTasks": 1
  }
}
```

## 🚀 快速测试脚本

### 一键测试脚本
```bash
#!/bin/bash

echo "开始测试分布式服务监控与部署系统..."

# 步骤1：下载和构建（无参数）
echo "步骤1：下载和构建代码..."
RESPONSE1=$(curl -s -X POST "http://localhost:8080/api/deploy/step1-download-and-build")
echo "步骤1结果: $RESPONSE1"

# 步骤2：部署服务（无参数）
echo "步骤2：部署服务..."
RESPONSE2=$(curl -s -X POST "http://localhost:8080/api/deploy/step2-deploy-service" \
  -H "Content-Type: application/json")
echo "步骤2结果: $RESPONSE2"

# 步骤3：查看状态
echo "步骤3：查看服务状态..."
RESPONSE3=$(curl -s -X GET "http://localhost:8080/api/deploy/step3-available-services")
echo "步骤3结果: $RESPONSE3"

echo "测试完成！"
```

## 🔍 故障排查

### 常见问题
1. **端口冲突**：确保Master(8080)、Agent(8082)、文件服务器(8081)端口不冲突
2. **目录权限**：确保 `/tmp` 目录有读写权限
3. **Redis连接**：确保Redis服务正常运行
4. **Git认证**：确保Git仓库URL和认证信息正确

### 日志查看
```bash
# Master节点日志
tail -f logs/master.log

# Agent节点日志
tail -f logs/agent.log
```

## 📊 验证清单

- [ ] Master节点启动成功
- [ ] Agent节点启动成功
- [ ] Redis连接正常
- [ ] 代码下载成功
- [ ] JAR包构建成功
- [ ] 服务部署成功
- [ ] 服务运行正常
- [ ] 监控状态正常

## 🎉 成功标志

当看到以下信息时，说明测试成功：
1. 所有API调用返回 `"success": true`
2. JAR包成功生成在配置的路径（从services.jar-path读取）
3. 服务在配置的Agent节点上成功启动（从services.target-nodes读取）
4. 监控显示服务状态为 `RUNNING`
